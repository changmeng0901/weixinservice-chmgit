<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>商品详情页</title>
	<meta name="keywords" content="" />
	<meta name="description" content="" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"/>
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="format-detection" content="telephone=no">
	<link rel="stylesheet" href="../style/Buy/reset.css">
    <link rel="stylesheet" href="../style/Buy/swiper.min.css">
	<link rel="stylesheet" href="../style/Buy/product_detail.css">
</head>
<body>
	<div class="wrap_productdetail">
		<!-- swiper 板块  -->
		<div class="swiper-container">
	        <div class="swiper-wrapper"></div>
	        <!-- Add Pagination -->
	        <div class="swiper-pagination"></div>
	        <!-- logo -->
	        <div class="logo" id="logo"><img src="../images/Buy/logo.jpg" /></div>
	        <div class="edit" id="enter_myorder" style="display: none;"><a href="javascript:;"><img src="../images/Buy/edit.png" ></a></div>
	    </div>
	    <div class="title">
	    	<p class="content">
	    		<span class="txt" id="product_name"></span>
	    		<span class="tip"><i id="freefreight_price_flag"></i>满<code id="free_freight_price"></code>元包邮</span>
	    	</p>
	    	<p class="prize"><i>￥</i><span id="product_price"></span></p>
	    </div>
	    <div class="detail">
	    	<p class="line" style="border-bottom:1px solid #e1e1e1;">
	    		<span class="fl">运费<i id="freight_price"></i></span>
	    		<span class="fr">销量 <i id="sale_num" style="margin-left: 0;"></i>笔</span>
	    	</p>
	    	<div class="line" id="enter_SPEC">
	        	<span class="text_name fl">已选<i id="option_product"></i></span>
	            <div class="fr inputBox">
	            	<span class="fl" id="Subtract"><img src="../images/Buy/icon_jian.jpg" /></span>
	                <input type="text" value="1" class="fl" id="Total" />
	                <span class="fr" id="Addition"><img src="../images/Buy/icon_jia.jpg" /></span>
	            </div>
	        </div>
	    </div>
	    <!-- 农场风光 板块 -->
	    <div class="show">
	    	<h4><span class="line"></span><span>农场风光</span><span class="line"></span></h4>
	    	<div class="pic" id="krpanos">
	    		<img src="" />
	    		<i class="icon1"></i>
	    		<p>#四季田景#</p>
	    		<div class="mask"></div>
	    	</div>
	        <div class="pic" id="aerial_video">
	            <img src="" />
	            <i class="icon2"></i>
	            <p>#航拍视频#</p>
	            <div class="mask"></div>
	        </div>
	        <div class="pic" id="farm_show">
	            <img src="" />
	            <i class="icon3"></i>
	            <p>#农场秀#</p>
	            <div class="mask"></div>
	            <div class="phone">
	                <img src="" alt="">
	            </div>
	        </div>
	    </div>
	    <div class="show">
	        <h4><span class="line"></span><span>绿色履历</span><span class="line"></span></h4>
	        <div class="pic" id="resume">
	            <img src="" />
	            <i class="icon4"></i>
	            <p>#商品履历#</p>
	            <div class="mask"></div>
	            <div class="phone">
	                <img src="" alt="">
	            </div>
	        </div>
	    </div>
	    <div class="show">
	        <h4><span class="line"></span><span>农场地图</span><span class="line"></span></h4>
	        <div class="pic map" id="farm_map">
	            <!--<img src="../images/Buy/map.jpg" />-->
	        </div>
	    </div>
	    <!-- 商品详情及评价 板块  -->
	    <div class="tabs">
	        <ul class="item">
	            <li class="cur">商品详情</li>
	            <li id="Evaluate">评价<span>（8）</span></li>
	        </ul>
	        <div class="details current">
	            <div class="goods_pic" id="product_introduction"></div>
	            <div class="show" id="Premium" style="border-bottom:0; padding:0;">
	                <h4><span class="line"></span><span>精选商品</span><span class="line"></span></h4>
	                <ul class="fruit clearfix" id="fruit_list"></ul>
	            </div>
	        </div>
	        <div class="details">
	            <!-- 有评价 -->
	            <ul class="has_evaluate" id="has_evaluate">
	                
	            </ul>
	            <!-- 没评价 -->
	            <div class="no_evaluate" id="no_evaluate">
	                <img src="../images/Buy/txt.png" alt="">
	                <p>暂无评价</p>
	            </div>
	        </div>
	        <div class="load_more premium_more"><p>加载中...</p></div>
	    </div>
	    
	    <div class="copyRight">Copyright北京奥科美技术服务有限公司</div>
	    
    </div>
    <!-- 定位底部加入购物车  板块 -->
    <ul class="purchase">
        <li class="nub1" id="EnterCart">
            <a href="javascript:;">
               <img src="../images/Buy/cart.png" />
                <i id="cart_total">0</i>
                <p>购物车</p> 
            </a> 
        </li>
        <li class="nub2" id="AddCart">加入购物车</li>
        <li class="nub3" id="BuyNow">立即购买</li>  
    </ul>
    
    <!-- 注册弹窗 -->
	<div class="mark_bind" onclick="MarkBindHide()"></div>
	<div class="registerPop" id="registerPop">
		<div class="member">
			<div class="pen"><img src="../images/Buy/pen.png" alt=""></div>
			<h4>注册会员账号</h4>
			<ul class="register_ul">
				<li class="info">
					<input type="text" value="手机号" class="entry1" id="phoneVal">
					<i class="icon1"></i>
					<p class="tip_phonenumber">手机号不正确，请输入正确的手机号</p>
				</li>
				<li class="info">
					<input type="text" value="验证码" class="entry2" id="securitycodeVal">
					<i class="icon2"></i>
					<span class="code fr" id="security_btn" code="" onclick="SecurityBtn()">验证码</span>
					<span class="time_s60 fr" id="time_s60">60s</span>
					<p class="tip_securitycode">验证码不正确</p>
				</li>
				<li class="regBtn" onclick="RegisterBinding()">注册并绑定</li>
			</ul>
		</div>
	</div>
    
</body>
<script type="text/javascript" src="../js/commons/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="../js/commons/jquery.lazyload.js"></script>
<script type="text/javascript" src="../js/swiper/swiper.min.js"></script>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=1.3"></script>
<script>
	
	var base64EncodeChars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";  
	var base64DecodeChars = new Array(-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 62, -1, -1, -1, 63, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, -1, -1, -1, -1, -1, -1, -1, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, -1, -1, -1, -1, -1, -1, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, -1, -1, -1, -1, -1);  
	/** 
	 * base64编码 
	 * @param {Object} str 
	 */  
	function base64encode(str){  
		var out, i, len;  
		var c1, c2, c3;  
		len = str.length;  
		i = 0;  
		out = "";  
		while (i < len) {  
			c1 = str.charCodeAt(i++) & 0xff;  
			if (i == len) {  
				out += base64EncodeChars.charAt(c1 >> 2);  
				out += base64EncodeChars.charAt((c1 & 0x3) << 4);  
				out += "==";  
				break;  
			}  
			c2 = str.charCodeAt(i++);  
			if (i == len) {  
				out += base64EncodeChars.charAt(c1 >> 2);  
				out += base64EncodeChars.charAt(((c1 & 0x3) << 4) | ((c2 & 0xF0) >> 4));  
				out += base64EncodeChars.charAt((c2 & 0xF) << 2);  
				out += "=";  
				break;  
			}  
			c3 = str.charCodeAt(i++);  
			out += base64EncodeChars.charAt(c1 >> 2);  
			out += base64EncodeChars.charAt(((c1 & 0x3) << 4) | ((c2 & 0xF0) >> 4));  
			out += base64EncodeChars.charAt(((c2 & 0xF) << 2) | ((c3 & 0xC0) >> 6));  
			out += base64EncodeChars.charAt(c3 & 0x3F);  
		}  
		return out;  
	}
	/** 
	 * base64解码 
	 * @param {Object} str 
	 */  
	function base64decode(str){  
		var c1, c2, c3, c4;  
		var i, len, out;  
		len = str.length;  
		i = 0;  
		out = "";  
		while (i < len) {  
			/* c1 */  
			do {  
				c1 = base64DecodeChars[str.charCodeAt(i++) & 0xff];  
			}  
			while (i < len && c1 == -1);  
			if (c1 == -1)   
				break;  
			/* c2 */  
			do {  
				c2 = base64DecodeChars[str.charCodeAt(i++) & 0xff];  
			}  
			while (i < len && c2 == -1);  
			if (c2 == -1)   
				break;  
			out += String.fromCharCode((c1 << 2) | ((c2 & 0x30) >> 4));  
			/* c3 */  
			do {  
				c3 = str.charCodeAt(i++) & 0xff;  
				if (c3 == 61)   
					return out;  
				c3 = base64DecodeChars[c3];  
			}  
			while (i < len && c3 == -1);  
			if (c3 == -1)   
				break;  
			out += String.fromCharCode(((c2 & 0XF) << 4) | ((c3 & 0x3C) >> 2));  
			/* c4 */  
			do {  
				c4 = str.charCodeAt(i++) & 0xff;  
				if (c4 == 61)   
					return out;  
				c4 = base64DecodeChars[c4];  
			}  
			while (i < len && c4 == -1);  
			if (c4 == -1)   
				break;  
			out += String.fromCharCode(((c3 & 0x03) << 6) | c4);  
		}  
		return out;  
	}  
	/** 
	 * utf16转utf8 
	 * @param {Object} str 
	 */  
	function utf16to8(str){  
		var out, i, len, c;  
		out = "";  
		len = str.length;  
		for (i = 0; i < len; i++) {  
			c = str.charCodeAt(i);  
			if ((c >= 0x0001) && (c <= 0x007F)) {  
				out += str.charAt(i);  
			}  
			else   
				if (c > 0x07FF) {  
					out += String.fromCharCode(0xE0 | ((c >> 12) & 0x0F));  
					out += String.fromCharCode(0x80 | ((c >> 6) & 0x3F));  
					out += String.fromCharCode(0x80 | ((c >> 0) & 0x3F));  
				}  
				else {  
					out += String.fromCharCode(0xC0 | ((c >> 6) & 0x1F));  
					out += String.fromCharCode(0x80 | ((c >> 0) & 0x3F));  
				}  
		}  
		return out;  
	}  
	/** 
	 * utf8转utf16 
	 * @param {Object} str 
	 */  
	function utf8to16(str){  
		var out, i, len, c;  
		var char2, char3;  
		out = "";  
		len = str.length;  
		i = 0;  
		while (i < len) {  
			c = str.charCodeAt(i++);  
			switch (c >> 4) {  
				case 0:  
				case 1:  
				case 2:  
				case 3:  
				case 4:  
				case 5:  
				case 6:  
				case 7:  
					// 0xxxxxxx  
					out += str.charAt(i - 1);  
					break;  
				case 12:  
				case 13:  
					// 110x xxxx 10xx xxxx  
					char2 = str.charCodeAt(i++);  
					out += String.fromCharCode(((c & 0x1F) << 6) | (char2 & 0x3F));  
					break;  
				case 14:  
					// 1110 xxxx10xx xxxx10xx xxxx  
					char2 = str.charCodeAt(i++);  
					char3 = str.charCodeAt(i++);  
					out += String.fromCharCode(((c & 0x0F) << 12) | ((char2 & 0x3F) << 6) | ((char3 & 0x3F) << 0));  
					break;  
			}  
		}  
		return out;  
	} 

	//------------------------cookie相关
	function getCookie(c_name){
		if (document.cookie.length>0){
			c_start=document.cookie.indexOf(c_name + "=")
			if (c_start!=-1){ 
				c_start=c_start + c_name.length+1 
				c_end=document.cookie.indexOf(";",c_start)
				if (c_end==-1) c_end=document.cookie.length
				return unescape(document.cookie.substring(c_start,c_end))
			} 
		}
		return ""
	}
	
	function setCookie(c_name,value,expiredays){
		var exdate=new Date()
		exdate.setDate(exdate.getDate()+expiredays)
		document.cookie=c_name+ "=" +escape(value)+
		((expiredays==null) ? "" : ";expires="+exdate.toGMTString())
	}
	
	/* 本地微信公众号下的产品详情页的测试地址
	 * http://szq.s1.natapp.cc/weixinservice/Buy/ProductDetail.html?enterprise_info_id=2&product_id=1&domain=http://192.168.21.207:8080
	 * */
	
	//微信
	var weixin_info = null,
		cookieinfo = '',
		openid = '',
		cookieinfo = getCookie("weixin_info_pay"),
		loginUrl,
		LocationUrl;
		
		
	
	
	var sumCount=''; //分页
	var page = 1;
	 
	//图片懒加载
	$("img").lazyload({
		effect: "fadeIn"
	});
		
	//SEARCH
	var http = 'http://szq.s1.natapp.cc'; 
	var iframeSearch = location.search.split("&");
	var getEnterpriseId = iframeSearch[0].split("=")[1];
	var getProductId = iframeSearch[1].split("=")[1];
	var getTestUrl = iframeSearch[2].split("=")[1];
	var getMemberInfo='';
	
	$.ajax({
		type: "GET",
		url: getTestUrl+'/rest/1.0/purchase',
		dataType: "jsonp",
		data:{
			'method':'product.info.data',
			'field':JSON.stringify({
				'enterprise_info_id' : getEnterpriseId,
				'product_id'         : getProductId
			})
		},		
		jsonp: 'callback',
		success: function(response) {
			if(response.invoke_result == 'INVOKE_SUCCESS'){
				if( response.purchase_product_info!='' && response.purchase_product_info!=null && response.purchase_product_info!=undefined ){
					InitInforData(response.purchase_product_info);	
				}
			}
			
		},
		error: function(e) {
			try {
				console.log('商品详情请求失败了！')
			} catch (e) {}
		}
	});  //ajax----end
	
	//购物车接口
	var CartAjax = function()
		{
		    $.ajax({
				type: "GET",
				url: getTestUrl+'/rest/1.0/purchase',
				dataType: "jsonp",
				data:{
					'method':'cart.data',
					'field':JSON.stringify({
						'enterprise_info_id' : getEnterpriseId,
						'member_info'        : getMemberInfo
					})
				},		
				jsonp: 'callback',
				success: function(response) {
					
					if(response.invoke_result == 'INVOKE_SUCCESS'){
						$('#cart_total').html( response.cart_num );
					}
					
				},
				error: function(e) {
					console.log('购物车接口请求失败！')
				}
			});  //ajax----end
		}
		
		
	if( cookieinfo == ''||cookieinfo == null ){
		
	}else{
		cookieinfo = base64decode(cookieinfo);
		cookieinfo = utf8to16(cookieinfo);
		weixin_info = JSON.parse( cookieinfo );
	    getMemberInfo = weixin_info.member_info_id;
	    getEnterpriseId = weixin_info.enterprise_info_id;
	    //如果已经登录过，则我的订单按钮显示，点击跳转到我的订单页面，否则按钮隐藏
	    if( getMemberInfo==''||getMemberInfo==null||getMemberInfo==undefined ){
			$('#enter_myorder').hide();
		}else{
			$('#enter_myorder').show();
		}
	    //如果已经登录过，则调用购物车接口，之后把返回的数量添加进去
	    CartAjax();
	    
	    
	}
	
	
	//右上角订单按钮，点击进入我的订单页
	$('#enter_myorder').click(function(){
		window.location.href = http+'/weixinservice/Buy/MyOrder.html?enterprise_info_id='+getEnterpriseId+'&member_info='+getMemberInfo+'&order_status=1&domain='+getTestUrl;
	});
	
	// 商品详情选项卡
	$('.tabs .item li').click(function() {
		var index = $(this).index();
		$(this).addClass('cur').siblings().removeClass('cur');
		$('.details').eq(index).addClass('current').siblings().removeClass('current');
	});
	
	//进入到规格选择页
	$('#option_product').click(function(){
		
		window.location.href = http+'/weixinservice/Buy/Specification.html?product_id='+ getProductId +'&enterprise_info_id='+getEnterpriseId +'&domain='+getTestUrl 
	
	});
	
	//加减计算
	$('#Subtract').click(function(){//减，最小为1
		var _num = Number($('#Total').val())-1;
		if( _num <= 1 ){ _num = 1 }
		$('#Total').val( _num );	
	});
	$('#Addition').click(function(){//加，最大为99
		var _num = Number($('#Total').val())+1;
		if( _num >= 99 ){ _num = 99 }
		$('#Total').val( _num );	
	});


	//初始化参数
	var InitInforData = function(_data)
		{
			//logo  Logo是否启用 1是 0不
			if( _data.logo.logo_flag == '0' ){
				$('#logo').hide();
			}else{
				$('#logo').show();
				$('#logo img').attr('src',_data.logo.logo_url);
			}
			//商品名称
			_data.product_name==''|| _data.product_name==undefined ?  $('#product_name').html('--') : $('#product_name').html( _data.product_name )
			//价格
			_data.product_price==''|| _data.product_price==undefined ? $('#product_price').html('--') : $('#product_price').html( _data.product_price )
			//是否免邮 1免邮 0不免
			if( _data.freight.freefreight_price_flag == '0' ){
				$('#freefreight_price_flag').html('不包邮');
			}else{
				$('#freefreight_price_flag').html('包邮');	
			}
			//运费价格
			_data.freight.freight_price==''|| _data.freight.freight_price==undefined ? $('#freight_price').html('￥--') : $('#freight_price').html( _data.freight.freight_price )
			//需满免邮
			_data.freight.free_freight_price==''|| _data.freight.free_freight_price==undefined ? $('#free_freight_price').html('--') : $('#free_freight_price').html( _data.freight.free_freight_price )
			//规格
			_data.product_unit==''|| _data.product_unit==undefined ? $('#option_product').html('--') : $('#option_product').html( _data.product_unit+$('#product_name').html() )
			//销量
			_data.sale_num==''|| _data.sale_num==undefined ?  $('#sale_num').html('--') : $('#sale_num').html( _data.sale_num )
			//是否启用四季田景 1是 0 不
			if( _data.krpanos.krpanos_flag == '0' ){
				$('#krpanos').hide();
			}else{
				$('#krpanos').show();	
				$('#krpanos img').attr('src',_data.krpanos.krpanos_image_url);
				$('#krpanos p').attr('krpanos_group_id',_data.krpanos.krpanos_group_id);
			}
			//是否启用航拍 1是 0 不
			if( _data.aerial_video.aerial_video_flag == '0' ){
				$('#aerial_video').hide();
			}else{
				$('#aerial_video').show();	
				$('#aerial_video img').attr('src',_data.aerial_video.aerial_video_image_url);
				$('#aerial_video p').attr('aerial_video_group_id',_data.aerial_video.aerial_video_group_id);
			}
			//是否启用农场秀 1是 0 不
			if( _data.farm_show.farm_show_flag == '0' ){
				$('#farm_show').hide();
			}else{
				$('#farm_show').show();	
				$('#farm_show img').attr('src',_data.farm_show.farm_show_image_url);
				$('#farm_show p').attr('farm_show_group_id',_data.farm_show.farm_show_group_id);
			}
			//是否启用履历 1是 0 不
			if( _data.resume.resume_flag == '0' ){
				$('#resume').hide();
			}else{
				$('#resume').show();	
				$('#resume img').attr('src',_data.resume.phone_model_info_image_url);
				$('#resume p').attr('resume_id',_data.resume.resume_id);
			}
			//是否启用农场地图 1是 0 不
			if( _data.farm_map.farm_map_flag == '0' ){
				$('#farm_map').hide();
			}else{
				$('#farm_map').show();	
				$('#farm_map').attr('farm_map_id',_data.farm_map.farm_map_id);
				var map = new BMap.Map('farm_map',{mapType:BMAP_NORMAL_MAP});//在百度地图容器中创建一个地图
		        var point = new BMap.Point(_data.farm_map.coordinate_Y,_data.farm_map.coordinate_X);//定义一个中心点坐标
		        map.centerAndZoom(point,13);//设定地图的中心点和坐标并将地图显示在地图容器中

			}
			
			//=========================================length>0
			//如果精选商品列表不为空，则执行精选商品列表函数
			if( _data.product_list!='' && _data.product_list!=null && _data.product_list!=undefined ){
				ProductListData(_data.product_list.purchase_product_list);
			}
			//商品详情，图片
			if( _data.product_introduction != '' &&  _data.product_introduction != undefined ){
				$('#product_introduction').append( _data.product_introduction );
			}
			
			//所有精选商品分页的数据条数总和：为：
			_data.total_page==''|| _data.total_page==undefined ?  sumCount = 0 : sumCount = _data.total_page;
			
			//商品展示图片,函数执行
			SwiperListData(_data.product_image);
			
			//评价总数量
			$('#Evaluate span').html('('+_data.comment_num+')');
			
		}//-------初始化参数结束
	
	//商品展示图片   SWIPER函数
	var SwiperListData = function(_data)
		{
			if( _data!='' && _data!=[] && _data!=undefined ){
				var _slider = '';
				var $swiperContainer = $('.swiper-container .swiper-wrapper');
				for( var k=0;k<_data.length;k++ ){
					_slider += '<div class="swiper-slide"><a href="javascript:;"><img src="'+ _data[k] +'" ></a></div>';	
				}
				$swiperContainer.append( _slider );
				//轮播图
				var swiper1 = new Swiper('.swiper-container', {
					pagination: '.swiper-pagination',
					paginationClickable: true, //值为真时，当单击指示器时会执行过渡动画到目标slide...
					autoplay: 3000,
					speed : 500,
					autoplayDisableOnInteraction: false,  //触摸后状态，true之后停止自动播放，false之后还可以自动播放
					loop : true, //无限循环切换
				});	
			}
			
		}//--------------end
	
	//精选商品列表函数
	var $fruit_list = $('#fruit_list');
	var ProductListData = function(_data)
		{
			var _list='',
				_classname = '';
			if(_data!=[] && _data!=undefined ){
					for( var i=0;i<_data.length;i++ ){
						//取膜，基数class=right_b,偶数class=left_b
						i%2==0 ? _classname='right_b' : _classname='left_b'
						//拼接精选商品列表
						_list += 
						'<li class="'+ _classname +'">'+
							'<a href="">'+
								'<img src="'+ _data[i].image_url +'" />'+
								'<h6>'+ _data[i].product_name +'</h6>'+
								'<p class="prize">￥'+ _data[i].product_price +'</p>'+
							'</a>'+
						'</li>';
					}
					$fruit_list.append( _list );
			}		
		}//--------------end
	
	// 上拉加载
	//var page = 1;
	$(window).on('touchmove',function(){
		var scrollH = $('.wrap_productdetail').scrollTop();
		//console.log(($(window).height() + scrollH) + ':' +($(document).height()))
		if( ($('body').height() + scrollH) >= $('.wrap_productdetail').outerHeight() ){
			page++;	
			if( page <= sumCount/4 ){
				$('.premium_more p').html('加载中...');
				$('.premium_more').show();
				setTimeout(function(){
					$('.premium_more').hide();
					LoadingMore( page );
				},500);		
			}else{
				$('.premium_more p').html('已经没有更多数据了');
				$('.premium_more').show();
				setTimeout(function(){
					$('.premium_more').hide();
				},500);		
			}
		}	
	});
	var LoadingMore = function( pageIndex )
		{
			if( $('.tabs .item li').eq(0).hasClass('cur') )	{
				
				//如果商品详情为选中状态，则加载更多精选商品
				$.ajax({
					type: "GET",
					url: getTestUrl+'/rest/1.0/purchase',
					dataType: "jsonp",
					data:{
						'method':'option.product.list.data',
						'field':JSON.stringify({
							'enterprise_info_id' : getEnterpriseId,
							'product_id'         : getProductId ,
							'page'               : pageIndex
						})
					},
					jsonp: 'callback',
					success: function( response ) {
						
						var _data = response.purchase_product_info.product_list.purchase_product_list;
						var _list='',
							_classname = '';
						if( _data.length>0 ){
								for( var i=0;i<_data.length;i++ ){
									//取膜，基数class=right_b,偶数class=left_b
									i%2==0 ? _classname='right_b' : _classname='left_b'
									//拼接精选商品列表
									_list += 
									'<li class="'+ _classname +'">'+
										'<a href="">'+
											'<img src="'+ _data[i].image_url +'" />'+
											'<h6>'+ _data[i].product_name +'</h6>'+
											'<p class="prize">￥'+ _data[i].product_price +'</p>'+
										'</a>'+
									'</li>';
								}
								$fruit_list.append( _list );
						}			
						
					},
					error: function(e) {
						try {
							console.log('加载更多精选商品请求失败了！')
						} catch (e) {}
					}
				});	//ajax----end
				
			}else if( $('.tabs .item li').eq(0).hasClass('cur') ){
				
				//如果评价为选中状态，则加载更多评价
				$.ajax({
					type: "GET",
					url: getTestUrl+'/rest/1.0/purchase',
					dataType: "jsonp",
					data:{
						'method':'query.comment.data',
						'field':JSON.stringify({
							'product_id'  : getProductId ,
							'page'        : pageIndex
						})
					},
					jsonp: 'callback',
					success: function( response ) {
						
						var _data = response.comment_list ;
						var $has_evaluate = $('#has_evaluate'),
							_commentlist = '';
							
						for ( var j=0;j<_data.length;j++ )
						{
							var comment_imglist='';
							var imglist = _data[j].comment_image_list;
							for ( var k=0;k<imglist.length;k++ )
							{
								comment_imglist += '<img src="'+imglist[k].comment_image+'" />'
							}
							//头像
							var head_portrait = '';
							if( _data[j].icon_url=='' || _data[j].icon_url==null ||　_data[j].icon_url==undefined ){
								head_portrait = '../images/Buy/photo.png';
							}else{
								head_portrait = _data[j].icon_url;
							}
							_commentlist += 
								'<li>'+
				                    '<div class="top_line">'+
				                       ' <span class="photo fl"><img src="'+head_portrait+'" /></span>'+
				                        '<span class="tel fl">'+_data[j].phone+'</span>'+
				                        '<span class="date fr">'+_data[j].comment_time+'</span>'+
				                   '</div>'+
				                    '<div class="stars">'+
				                        '<p class="stars_iconbg sta'+_data[j].score+'"></p>'+
				                    '</div>'+
				                    '<p class="txt">'+_data[j].comment+'</p>'+
				                    '<div class="pics">'+comment_imglist+'</div>'
				                '</li>';
						}
						$has_evaluate.append( _commentlist );
						
					},
					error: function(e) {
						try {
							console.log('加载更多评价请求失败了！')
						} catch (e) {}
					}
				});	//ajax----end
				
			}
			
				
		}
	
	
	//点击评价事件
	$('#Evaluate').click(function(){
		
		$.ajax({
			type: "GET",
			url: getTestUrl+'/rest/1.0/purchase',
			dataType: "jsonp",
			data:{
				'method':'query.comment.data',
				'field':JSON.stringify({
					'product_id'  : getProductId ,
					'page'        : 1
				})
			},
			jsonp: 'callback',
			success: function( response ) {
				
				if(response.invoke_result == 'INVOKE_SUCCESS'){
					if( response.comment_list.length==0 ){
						//无评价数据
						$('#Evaluate span').html('('+response.comment_num+')');
						$('#has_evaluate').hide();
						$('#no_evaluate').show();
					}else{
						//有评价数据
						$('#Evaluate span').html('('+response.comment_num+')');	
						$('#has_evaluate').show();
						$('#no_evaluate').hide();
						InitCommentData( response.comment_list );
					}
				}
				
			},
			error: function(e) {
				try {
					console.log('点击评价请求失败了！')
				} catch (e) {}
			}
		});	//ajax---end
		
	});
	
	var InitCommentData = function( _data ){
		
		var $has_evaluate = $('#has_evaluate'),
			_commentlist = '';
			
		for ( var j=0;j<_data.length;j++ )
		{
			var comment_imglist='';
			var imglist = _data[j].comment_image_list;
			
			for ( var k=0;k<imglist.length;k++ )
			{
				comment_imglist += '<img src="'+imglist[k].comment_image+'" />'
			}
			//头像
			var head_portrait = '';
			if( _data[j].icon_url=='' || _data[j].icon_url==null ||　_data[j].icon_url==undefined ){
				head_portrait = '../images/Buy/photo.png';
			}else{
				head_portrait = _data[j].icon_url;
			}
			_commentlist += 
				'<li>'+
                    '<div class="top_line">'+
                       ' <span class="photo fl"><img src="'+head_portrait+'" /></span>'+
                        '<span class="tel fl">'+_data[j].phone+'</span>'+
                        '<span class="date fr">'+_data[j].comment_time+'</span>'+
                   '</div>'+
                    '<div class="stars">'+
                        '<p class="stars_iconbg sta'+_data[j].score+'"></p>'+
                    '</div>'+
                    '<p class="txt">'+_data[j].comment+'</p>'+
                    '<div class="pics">'+comment_imglist+'</div>'
                '</li>';
		}
		$has_evaluate.append( _commentlist );
		
		//所有评价分页的数据条数总和：为：
		_data.comment_total_page==''|| _data.comment_total_page==undefined ?  sumCount = 0 : sumCount = _data.comment_total_page;
		
	}
	
	//微信
	/*var weixin_info = null,
		cookieinfo = '',
		openid = ''; 
		cookieinfo = getCookie("weixin_info_pay");
	var loginUrl;
*/
	//判断类型：1=微信浏览器，2=非微信
	var type_wx = '';
	if( isWeiXin() ){
		
		type_wx = 1;
		
		//点击加入购物车事件
		$('#AddCart').click(function(){
			
			//console.log($('#Total').val()+'@@'+cookieinfo)
			if( cookieinfo == ''||cookieinfo == null ||cookieinfo == undefined ){
				
				//如果未登录过，跳指定页面拉取登录
				LocationUrl = window.location.href;
				LocationUrl = encodeURIComponent(LocationUrl);//转义一下

				$.ajax({
			        url : "http://magicbutton.s1.natapp.cc/rest/1.0/purchase?method=wechat.login.info",
			        type : "get",
			        dataType : "jsonp",
			        data:{'specialOne':2,'specialTwo':LocationUrl},
			        contentType:"application/json",
			        success : function(data){
			        	
			            if(data.invoke_result == 'INVOKE_SUCCESS'){
			                window.location.href = data.LoginUrl;
			            }
			            
			        }
			    }); 
				
			}else{
				
				//如果已登录
				cookieinfo = getCookie("weixin_info_pay");
				cookieinfo = base64decode(cookieinfo);
				cookieinfo = utf8to16(cookieinfo);
				weixin_info = JSON.parse( cookieinfo );
				getMemberInfo = weixin_info.member_info_id;//weixin_info.openid   8867
				
				$.ajax({
					type: "GET",
					url: getTestUrl+'/rest/1.0/purchase',
					dataType: "jsonp",
					data:{
						'method':'add.cart.data',
						'field':JSON.stringify({
							'enterprise_info_id' : getEnterpriseId,
							'member_info'        : getMemberInfo,
							'product_id'         : getProductId ,
							'product_num'        : $('#Total').val(),
						})
					},
					jsonp: 'callback',
					success: function( response ) {
						
						CartAjax();
						var Numbcartnum = Number($('#cart_total').html());
			            $('#cart_total').html( Numbcartnum+1 );
			            
					},
					error: function(e) {
						try {
							console.log('点击加入购物车请求失败了！')
						} catch (e) {}
					}
				});	//ajax---end
				
			}
			
		});	
		
		
		//点击购物车---进入购物车列表页
		$('#EnterCart').click(function(){
			
			if( cookieinfo == ''||cookieinfo == null ||cookieinfo == undefined ){
				
				//如果未登录过，跳指定页面拉取登录
				LocationUrl = window.location.href;
				LocationUrl = encodeURIComponent(LocationUrl);//转义一下

				$.ajax({
			        url : "http://magicbutton.s1.natapp.cc/rest/1.0/purchase?method=wechat.login.info",
			        type : "get",
			        dataType : "jsonp",
			        data:{'specialOne':2,'specialTwo':LocationUrl},
			        contentType:"application/json",
			        success : function(data){
			        	
			            if(data.invoke_result == 'INVOKE_SUCCESS'){
			                window.location.href = data.LoginUrl;
			            }
			            
			        }
			    }); 
				
			}else{
				
				//如果已登录
				cookieinfo = getCookie("weixin_info_pay");
				cookieinfo = base64decode(cookieinfo);
				cookieinfo = utf8to16(cookieinfo);
				weixin_info = JSON.parse( cookieinfo );
				getMemberInfo = weixin_info.member_info_id;//weixin_info.openid   8867
				//openid = weixin_info.openid;  //weixin_info.openid  8867*/
				
				window.location.href = http+'/weixinservice/Buy/cart.html?enterprise_info_id='+getEnterpriseId+'&member_info='+getMemberInfo+'&domain='+getTestUrl;
				
			}
			
		});	
		
		
		//点击立即购买---
		$('#BuyNow').click(function(){
			
			if( cookieinfo == ''||cookieinfo == null ||cookieinfo == undefined ){
				
				//如果未登录过，跳指定页面拉取登录
				LocationUrl = window.location.href;
				LocationUrl = encodeURIComponent(LocationUrl);//转义一下

				$.ajax({
			        url : "http://magicbutton.s1.natapp.cc/rest/1.0/purchase?method=wechat.login.info",
			        type : "get",
			        dataType : "jsonp",
			        data:{'specialOne':2,'specialTwo':LocationUrl},
			        contentType:"application/json",
			        success : function(data){
			        	
			            if(data.invoke_result == 'INVOKE_SUCCESS'){
			                window.location.href = data.LoginUrl;
			            }
			            
			        }
			    }); 
				
			}else{
				
				//如果已登录
				cookieinfo = getCookie("weixin_info_pay");
				cookieinfo = base64decode(cookieinfo);
				cookieinfo = utf8to16(cookieinfo);
				weixin_info = JSON.parse( cookieinfo );
				getMemberInfo = weixin_info.member_info_id;//weixin_info.openid   8867
				//openid = weixin_info.openid;  //weixin_info.openid  8867*/
				
				//设置cookie(商品列表信息)
				var ListArr = [];
				ListArr[0] = JSON.stringify({
						"product_img": $('.swiper-wrapper .swiper-slide').eq(0).find('img').attr('src'),
						"product_id": getProductId,
						"product_name": $('#product_name').html(),
						"product_num": $('#Total').val(),
						"product_price": $('#product_price').html(),
						"product_unit": $('#option_product').html() //有问题
					});
				var spOrderArr = '['+ListArr+']';
				setCookie('spOrderCookie','');
				setCookie('spOrderCookie',spOrderArr);
				
				window.location.href = http+'/weixinservice/Buy/PaymentOrders.html?enterprise_info_id='+getEnterpriseId+'&member_info='+getMemberInfo+'&domain='+getTestUrl;
				
			}
			
		});	
		
		
	}else{
		
		//如果是非微信浏览器，并且cookie里没有cookieinfo = getCookie("weixin_info_pay")的值
		type_wx = 2;	
		
		//点击加入购物车事件
		$('#AddCart').click(function(){
			
			if( cookieinfo == ''||cookieinfo == null ||cookieinfo == undefined ){
				$('.mark_bind').show();
				$('#registerPop').show();
				$('.wrap_productdetail').addClass('overflowH');
			}else{
				$('.mark_bind').hide();
				$('#registerPop').hide();
				$('.wrap_productdetail').removeClass('overflowH');
			}
			
		});	
		
		//点击购物车---进入购物车列表页
		$('#EnterCart').click(function(){
			
			if( cookieinfo == ''||cookieinfo == null ||cookieinfo == undefined ){
				$('.mark_bind').show();
				$('#registerPop').show();
				$('.wrap_productdetail').addClass('overflowH');
			}else{
				$('.mark_bind').hide();
				$('#registerPop').hide();
				$('.wrap_productdetail').removeClass('overflowH');
			}
			
		});	
		
		//点击立即购买---
		$('#BuyNow').click(function(){
			
			if( cookieinfo == ''||cookieinfo == null ||cookieinfo == undefined ){
				$('.mark_bind').show();
				$('#registerPop').show();
				$('.wrap_productdetail').addClass('overflowH');
			}else{
				$('.mark_bind').hide();
				$('#registerPop').hide();
				$('.wrap_productdetail').removeClass('overflowH');
			}
			
		});	
		
		
		
//		if( cookieinfo == ''||cookieinfo == null ||cookieinfo == undefined ){
//			$('.mark_bind').show();
//			$('#registerPop').show();
//			$('.wrap_productdetail').addClass('overflowH');
//		}else{
//			$('.mark_bind').hide();
//			$('#registerPop').hide();
//			$('.wrap_productdetail').removeClass('overflowH');
//		}
		
		//var r=confirm("请用微信打开此页面!");
		//if (r==true){
			//window.location.href = 'http://www.baidu.com';
		//}
		
	}
	
	
	


//----------------------------onload之后的独立函数，如下：

//------------------------------------------------------绑定手机号
	// 立即绑定按钮
 	var PromptlyBinding = function(obj,oParent)
	 	{
	 		$('.wrap_productdetail').addClass('overflowH');
	 		$('.mark_bind').show();
	 		$(oParent).show();
	 	}
// 	var MarkBindHide = function()
//	 	{
//	 		$('.wrap_productdetail').removeClass('overflowH');
//	 		$('.mark_bind').hide();
//	 		$('#registerPop').hide();
//	 	
//	 	}	
	//注册并绑定按钮
 	var phoneVal = $('#phoneVal').val(),
 		securitycodeVal = $('#securitycodeVal').val();
 	var RegisterBinding = function()
	 	{
	 		phoneVal = $('#phoneVal').val(),
	 		securitycodeVal = $('#securitycodeVal').val();
	 		$('.tip_phonenumber').hide();//提示
	 		$('.tip_securitycode').hide();//提示
	 		
	 		if( phoneVal == '手机号' || phoneVal == '' || !IsPhone(phoneVal) || phoneVal.length!=11 ){
	 			
	 			//如果手机号码不正确
	 			$('#phoneVal').val( phoneVal );
	 			$('#securitycodeVal').val( securitycodeVal );
	 			$('.tip_phonenumber').show();//提示
	 			$('.tip_securitycode').hide();//提示
	 			
	 		}else if( securitycodeVal=='验证码' ||　securitycodeVal=='' || securitycodeVal.length!=6 ){
	 			
	 			//如果验证码不正确
	 			$('#phoneVal').val( phoneVal );
	 			$('#securitycodeVal').val( securitycodeVal );
	 			$('.tip_phonenumber').hide();//提示
	 			$('.tip_securitycode').show();//提示
	 			
	 		}else{
	 			
	 			//如果注册并绑定成功，则重新刷新页面
	 			$.ajax({
			        type: "GET",
					url: getTestUrl+'/rest/1.0/purchase',
					dataType: "jsonp",
					data:{
						'method':'login.method.data',
						'field':JSON.stringify({
							'enterprise_info_id' : getEnterpriseId	,
							//'memeber_info'       : getMemberInfo,
							'phone'              : phoneVal,
							'code'               : securitycodeVal
						})
					},
					jsonp: 'callback',
					success: function( response ) {
						
						if( response.result == 'failed' ){
							alert(response.message)
						}else{
							alert(getCookie("weixin_info_pay"));
							window.location.reload(); 
							//cookieinfo = settCookie("weixin_info_pay")
							
						}
						
					},
					error: function(e) {
						console.log('！')
					}
			    });
	 			
	 			
	 		}
	 	}
 	//验证码按钮----点击之后倒计时60s，且当弹框关闭后时间还继续走，目的防止二次点击
 	var SecurityBtn = function(){
 		phoneVal = $('#phoneVal').val();
 		if( phoneVal != '手机号' && phoneVal != '' && IsPhone(phoneVal) && phoneVal.length==11 ){
 			
 			$('.tip_phonenumber').hide();//提示
	 		$('.tip_securitycode').hide();//提示
 			
 			$.ajax({
				type: "GET",
				url: getTestUrl+'/rest/1.0/purchase',
				dataType: "jsonp",
				data:{
					'method':'get.verification.data',
					'field':JSON.stringify({
						'phone' : $('#phoneVal').val()	
					})
				},
				jsonp: 'callback'
			});	//-----end ajax
			
			var Stimer = null,
 				Mtime = 60;
	 		//定时器
	 		clearInterval( Stimer );
	 		Stimer = setInterval(function(){
	 			
	 			if(Mtime==0){
	 				clearInterval( Stimer );
	 				Mtime = 60;
	 				$('#security_btn').show();
	 				$('#time_s60').hide();
	 				$('#time_s60').html('60s');
	 			}
	 			Mtime--;
	 			$('#time_s60').html(Mtime+'s')
	 			
	 		},1000)
	 		$('#security_btn').hide();
	 		$('#time_s60').show();
			
 		}else{
 			
 			$('.tip_phonenumber').show();//提示
	 		$('.tip_securitycode').hide();//提示
 			
 		}
 		
 	}
 	
 	//获取焦点和失去焦点
 	$('input[type=text],textarea').focus(function(){
		var txt_value = $(this).val();
		if(txt_value==this.defaultValue){
			$(this).val("");          
		};	
	});
	$('input[type=text],textarea').blur(function(){
		var txt_value = $(this).val();
		if(txt_value==""){
			$(this).val(this.defaultValue);
		};	     
	});	
 	
 	//封装判断手机号函数
	var IsPhone = function(inpurStr)
	{
		var partten = /^(13[0-9]|15[012356789]|17[01236789]|18[0-9]|14[57])[0-9]{8}$/;
		if(partten.test(inpurStr))
		{
		   //alert('是电话号码');
		   return true;
		}
		else
		{
		   //alert('不是电话号码');
		   return false;
		}
	} 
    //------------------------------------------------------绑定手机号

//判断用户是否是用微信浏览器
function isWeiXin(){
	var ua = window.navigator.userAgent.toLowerCase();
	if(ua.match(/MicroMessenger/i) == 'micromessenger'){
		return true;
	}else{
		return false;
	}
}


</script>
</html>